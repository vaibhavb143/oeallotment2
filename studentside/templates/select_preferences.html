{% extends "base.html" %}
{% block title %}Select Preferences{% endblock %}

{% block content %}

<div class="container mt-4">
  <div class="row justify-content-center">
    <div class="col-lg-10">
      
      <div class="card shadow-sm">
        <div class="card-body">

          <h3 class="text-center mb-3 fw-bold">Select Your Subject Preferences</h3>
          <p class="text-center text-muted mb-4">
            Arrange your preferred subjects in order. Each preference number must be unique.
          </p>

          {% if existing_prefs %}
            <div class="alert alert-info">
              <strong>Your submitted preferences:</strong>
              <ul class="mt-2">
                {% for p in existing_prefs %}
                  <li><strong>{{ p.priority }}</strong> â†’ {{ p.subject.name }}</li>
                {% endfor %}
              </ul>
            </div>

            <div class="text-center">
              <a class="btn btn-secondary" href="{% url 'student_dashboard' %}">Back to Dashboard</a>
            </div>

          {% else %}

          <form method="post" onsubmit="return validatePreferences()">
            {% csrf_token %}

            <div class="table-responsive">
              <table class="table table-hover align-middle">
                <thead class="table-primary">
                  <tr>
                    <th>Subject</th>
                    <th>Remaining Seats</th>
                    <th>Preference Order</th>
                  </tr>
                </thead>

                <tbody>
                  {% for s in subjects %}
                  <tr>
                    <td class="fw-semibold">{{ s.name }}</td>
                    <td>{{ s.remaining_seats }}</td>

                    <td>
                      <select class="form-select" name="subject_order">
                        <option value="">-- Select --</option>
                        {% for i in subjects %}
                          <option value="{{ s.id }}-{{ forloop.counter }}">{{ forloop.counter }}</option>
                        {% endfor %}
                      </select>
                    </td>

                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>

            <div class="text-center mt-3">
              <button class="btn btn-primary px-4" type="submit">Submit Preferences</button>
              <a class="btn btn-link" href="{% url 'student_dashboard' %}">Cancel</a>
            </div>

          </form>

          {% endif %}
        </div>
      </div>

    </div>
  </div>
</div>

{% block scripts %}
<script>
function validatePreferences() {
    const selects = document.querySelectorAll('select[name="subject_order"]');
    const usedPrefs = new Set();

    for (let sel of selects) {
        const val = sel.value;
        if (!val) {
            alert("Please select a preference for every subject.");
            return false;
        }

        const pref = val.split('-')[1];

        if (usedPrefs.has(pref)) {
            alert("Each preference number must be unique.");
            return false;
        }

        usedPrefs.add(pref);
    }
    return true;
}
</script>
{% endblock %}

{% endblock %}
